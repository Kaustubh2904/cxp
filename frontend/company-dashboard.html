<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Dashboard - Company Exam Portal</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h2>üè¢ Company Dashboard</h2>
            </div>
            <div class="nav-links">
                <a href="company-dashboard.html" class="nav-link active">Drives</a>
                <button onclick="logout()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Logout</button>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>My Recruitment Drives</h1>
                <div>
                    <button onclick="loadDrives()" class="btn btn-secondary" style="margin-right: 1rem;">
                        üîÑ Refresh
                    </button>
                    <button onclick="window.location.href='company-create-drive.html'" class="btn btn-primary">
                        + Create New Drive
                    </button>
                </div>
            </div>

            <div id="drivesContainer"></div>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script>
        requireAuth('company');

        async function loadDrives() {
            const container = document.getElementById('drivesContainer');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const drives = await API.request(API_CONFIG.ENDPOINTS.COMPANY_DRIVES);
                
                if (drives.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <strong>No drives yet!</strong> 
                            <p>Click "Create New Drive" to get started.</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                drives.forEach(drive => {
                    html += `
                        <tr ${drive.status === 'rejected' || drive.status === 'suspended' ? 'style="background-color: #fff3f3;"' : ''}>
                            <td>
                                <strong>${drive.title}</strong><br>
                                <small style="color: var(--text-secondary);">${drive.description || 'No description'}</small>
                                ${drive.admin_notes ? `<br><small style="color: #dc3545;"><strong>Admin Notes:</strong> ${drive.admin_notes}</small>` : ''}
                            </td>
                            <td>${drive.question_type}</td>
                            <td>${drive.duration_minutes} min</td>
                            <td>${getStatusBadge(drive.status)}</td>
                            <td>${formatDate(drive.created_at)}</td>
                            <td>
                                <button class="btn btn-primary" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                        onclick="viewDrive(${drive.id})">
                                    View
                                </button>
                                ${drive.status === 'draft' ? `
                                    <button class="btn btn-warning" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="editDrive(${drive.id})">
                                        Edit
                                    </button>
                                    <button class="btn btn-success" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="submitDrive(${drive.id})">
                                        Submit
                                    </button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="deleteDrive(${drive.id})">
                                        Delete
                                    </button>
                                ` : drive.status === 'rejected' ? `
                                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="duplicateDrive(${drive.id})">
                                        Copy & Resubmit
                                    </button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="deleteDrive(${drive.id})">
                                        Delete
                                    </button>
                                ` : drive.status === 'suspended' ? `
                                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="duplicateDrive(${drive.id})">
                                        Copy
                                    </button>
                                    <small style="color: #856404;">Contact admin to reactivate</small>
                                ` : drive.status === 'submitted' ? `
                                    <small style="color: #856404;">Waiting for admin approval...</small>
                                ` : ''}
                                ${drive.is_approved && drive.status === 'approved' ? `
                                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="sendEmails(${drive.id})">
                                        üìß Send Emails
                                    </button>
                                ` : ''}
                                ${drive.status !== 'submitted' && drive.status !== 'suspended' ? `
                                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; margin: 0.25rem;" 
                                            onclick="duplicateDrive(${drive.id})">
                                        Copy
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        }

        function viewDrive(id) {
            window.location.href = `company-drive-detail.html?id=${id}`;
        }

        function editDrive(id) {
            window.location.href = `company-create-drive.html?id=${id}`;
        }

        async function submitDrive(id) {
            if (!confirm('Submit this drive for admin approval?')) return;

            try {
                await API.request(API_CONFIG.ENDPOINTS.COMPANY_SUBMIT_DRIVE(id), {
                    method: 'PUT'
                });
                showAlert('Drive submitted for approval!', 'success');
                loadDrives();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function deleteDrive(id) {
            if (!confirm('Delete this drive? This action cannot be undone.')) return;

            try {
                await API.request(API_CONFIG.ENDPOINTS.COMPANY_DELETE_DRIVE(id), {
                    method: 'DELETE'
                });
                showAlert('Drive deleted successfully', 'success');
                loadDrives();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function duplicateDrive(id) {
            try {
                await API.request(API_CONFIG.ENDPOINTS.COMPANY_DUPLICATE_DRIVE(id), {
                    method: 'POST'
                });
                showAlert('Drive duplicated successfully!', 'success');
                loadDrives();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function sendEmails(id) {
            window.location.href = `company-send-emails.html?id=${id}`;
        }

        loadDrives();
    </script>
</body>
</html>
